<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タグ管理エディタ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-card { cursor: pointer; transition: transform 0.2s; }
        .image-card:hover { transform: scale(1.02); }
        .tag-input { border: none; outline: none; background: transparent; }
        .tag-badge { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1>🏷️ タグ管理エディタ</h1>
        <p class="text-muted">画像をクリックしてタグを編集できます</p>
        
        <div class="row g-3" id="imageGrid">
            <!-- 画像が動的に表示される -->
        </div>
    </div>

    <!-- タグ編集モーダル -->
    <div class="modal fade" id="tagModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">タグを編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" class="img-fluid mb-3" style="max-height: 200px;">
                    <h6 id="modalTitle"></h6>
                    
                    <div class="mb-3">
                        <label class="form-label">現在のタグ</label>
                        <div id="currentTags" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newTag" class="form-label">新しいタグを追加</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newTag" placeholder="タグ名を入力">
                            <button class="btn btn-primary" type="button" onclick="addTag()">追加</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">よく使うタグ</label>
                        <div id="commonTags" class="d-flex flex-wrap gap-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveTags()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentItem = null;
        let items = [];
        let tagDefinitions = {};
        let tagStats = {};
        
        const commonTagsList = [
            'ui', 'nature', 'character', 'background', 'interactive', 
            'red', 'blue', 'green', 'button', 'icon', 'landscape',
            'indoor', 'outdoor', 'medieval', 'modern', 'cute', 'dark'
        ];

        // タグ定義を読み込み
        async function loadTagDefinitions() {
            try {
                const response = await fetch('data/tags.json');
                const data = await response.json();
                data.tags.forEach(tag => {
                    tagDefinitions[tag.id] = tag;
                });
                console.log('Loaded tag definitions:', Object.keys(tagDefinitions).length);
            } catch (error) {
                console.warn('Could not load tag definitions:', error);
            }
        }

        // 画像一覧を読み込み
        async function loadImages() {
            try {
                const response = await fetch('assets.json');
                const data = await response.json();
                items = data.items || [];
                
                // タグ統計を計算
                calculateTagStats();
                
                renderImages();
            } catch (error) {
                console.error('Failed to load images:', error);
            }
        }

        // タグ統計を計算
        function calculateTagStats() {
            tagStats = {};
            items.forEach(item => {
                (item.tagIds || item.tags || []).forEach(tagId => {
                    tagStats[tagId] = (tagStats[tagId] || 0) + 1;
                });
            });
        }

        // タグ名を取得（タグ定義がある場合は正式名、ない場合はID）
        function getTagDisplayName(tagId) {
            return tagDefinitions[tagId]?.name || tagId;
        }

        // タグの色を取得
        function getTagColor(tagId) {
            return tagDefinitions[tagId]?.color || '#6c757d';
        }

        // 画像一覧を表示
        function renderImages() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = items.map(item => {
                const displayTags = (item.tagIds || item.tags || []).map(tagId => {
                    const name = getTagDisplayName(tagId);
                    const color = getTagColor(tagId);
                    const count = tagStats[tagId] || 0;
                    return `<span class="badge" style="background-color: ${color}" title="${count}個の画像で使用">${name}</span>`;
                }).join(' ');
                
                return `
                <div class="col-md-4 col-lg-3">
                    <div class="card image-card h-100" onclick="openTagModal('${item.id}')">
                        <img src="${item.thumb}" class="card-img-top" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${item.title}</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${displayTags}
                            </div>
                            <small class="text-muted">${item.category}</small>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // タグ編集モーダルを開く
        function openTagModal(itemId) {
            currentItem = items.find(item => item.id === itemId);
            if (!currentItem) return;

            document.getElementById('modalImage').src = currentItem.thumb;
            document.getElementById('modalTitle').textContent = currentItem.title;
            
            renderCurrentTags();
            renderCommonTags();
            
            new bootstrap.Modal(document.getElementById('tagModal')).show();
        }

        // 現在のタグを表示
        function renderCurrentTags() {
            const container = document.getElementById('currentTags');
            const currentTags = currentItem.tagIds || currentItem.tags || [];
            
            container.innerHTML = currentTags.map(tagId => {
                const name = getTagDisplayName(tagId);
                const color = getTagColor(tagId);
                const count = tagStats[tagId] || 0;
                return `
                <span class="badge tag-badge" 
                      style="background-color: ${color}; cursor: pointer;" 
                      onclick="removeTag('${tagId}')"
                      title="${count}個の画像で使用中">
                    ${name} ×
                </span>
                `;
            }).join('');
        }

        // よく使うタグを表示
        function renderCommonTags() {
            const container = document.getElementById('commonTags');
            
            // 使用頻度でソートされたタグリスト
            const sortedTags = Object.entries(tagStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([tagId]) => tagId);
            
            // commonTagsListと統合
            const allCommonTags = Array.from(new Set([...sortedTags, ...commonTagsList]));
            
            container.innerHTML = allCommonTags.map(tagId => {
                const name = getTagDisplayName(tagId);
                const color = getTagColor(tagId);
                const count = tagStats[tagId] || 0;
                const currentTags = currentItem.tagIds || currentItem.tags || [];
                const isAlreadyAdded = currentTags.includes(tagId);
                
                return `
                <span class="badge tag-badge ${isAlreadyAdded ? 'bg-success' : ''}" 
                      onclick="${isAlreadyAdded ? '' : `addCommonTag('${tagId}')`}"
                      style="cursor: pointer; ${isAlreadyAdded ? '' : `border: 1px solid ${color}; color: ${color}; background: transparent;`}"
                      title="${count}個の画像で使用中">
                    ${isAlreadyAdded ? '✓ ' : '+ '}${name}
                </span>
                `;
            }).join('');
        }

        // タグを追加
        function addTag() {
            const input = document.getElementById('newTag');
            const tagId = input.value.trim();
            if (tagId && !getCurrentTagIds().includes(tagId)) {
                getCurrentTagIds().push(tagId);
                input.value = '';
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // よく使うタグを追加
        function addCommonTag(tagId) {
            const currentTags = getCurrentTagIds();
            if (!currentTags.includes(tagId)) {
                currentTags.push(tagId);
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // タグを削除
        function removeTag(tagId) {
            const currentTags = getCurrentTagIds();
            const index = currentTags.indexOf(tagId);
            if (index > -1) {
                currentTags.splice(index, 1);
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // 現在のタグIDリストを取得
        function getCurrentTagIds() {
            if (!currentItem.tagIds) {
                currentItem.tagIds = currentItem.tags || [];
            }
            return currentItem.tagIds;
        }

        // タグを保存（実際の実装では、サーバーサイドAPIが必要）
        function saveTags() {
            // ここで実際にはサーバーにデータを送信
            console.log('Saving tags for', currentItem.id, ':', currentItem.tags);
            
            // ローカルストレージに一時保存（デモ用）
            const savedTags = JSON.parse(localStorage.getItem('editedTags') || '{}');
            savedTags[currentItem.id] = currentItem.tags;
            localStorage.setItem('editedTags', JSON.stringify(savedTags));
            
            // 画面を更新
            renderImages();
            bootstrap.Modal.getInstance(document.getElementById('tagModal')).hide();
            
            alert('タグが保存されました！');
        }

        // Enterキーでタグ追加
        document.getElementById('newTag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTag();
            }
        });

        // ページ読み込み時に実行
        Promise.all([loadTagDefinitions(), loadImages()]);
    </script>
</body>
</html>
