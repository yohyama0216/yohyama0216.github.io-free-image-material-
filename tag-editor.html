<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚°ç®¡ç†ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-card { cursor: pointer; transition: transform 0.2s; }
        .image-card:hover { transform: scale(1.02); }
        .tag-input { border: none; outline: none; background: transparent; }
        .tag-badge { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1>ğŸ·ï¸ ã‚¿ã‚°ç®¡ç†ã‚¨ãƒ‡ã‚£ã‚¿</h1>
        <p class="text-muted">ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¿ã‚°ã‚’ç·¨é›†ã§ãã¾ã™</p>
        
        <div class="row g-3" id="imageGrid">
            <!-- ç”»åƒãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>

    <!-- ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="tagModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¿ã‚°ã‚’ç·¨é›†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" class="img-fluid mb-3" style="max-height: 200px;">
                    <h6 id="modalTitle"></h6>
                    
                    <div class="mb-3">
                        <label class="form-label">ç¾åœ¨ã®ã‚¿ã‚°</label>
                        <div id="currentTags" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newTag" class="form-label">æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newTag" placeholder="ã‚¿ã‚°åã‚’å…¥åŠ›">
                            <button class="btn btn-primary" type="button" onclick="addTag()">è¿½åŠ </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ã‚ˆãä½¿ã†ã‚¿ã‚°</label>
                        <div id="commonTags" class="d-flex flex-wrap gap-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="saveTags()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentItem = null;
        let items = [];
        let tagDefinitions = {};
        let tagStats = {};
        
        const commonTagsList = [
            'ui', 'nature', 'character', 'background', 'interactive', 
            'red', 'blue', 'green', 'button', 'icon', 'landscape',
            'indoor', 'outdoor', 'medieval', 'modern', 'cute', 'dark'
        ];

        // ã‚¿ã‚°å®šç¾©ã‚’èª­ã¿è¾¼ã¿
        async function loadTagDefinitions() {
            try {
                const response = await fetch('data/tags.json');
                const data = await response.json();
                data.tags.forEach(tag => {
                    tagDefinitions[tag.id] = tag;
                });
                console.log('Loaded tag definitions:', Object.keys(tagDefinitions).length);
            } catch (error) {
                console.warn('Could not load tag definitions:', error);
            }
        }

        // ç”»åƒä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadImages() {
            try {
                const response = await fetch('assets.json');
                const data = await response.json();
                items = data.items || [];
                
                // ã‚¿ã‚°çµ±è¨ˆã‚’è¨ˆç®—
                calculateTagStats();
                
                renderImages();
            } catch (error) {
                console.error('Failed to load images:', error);
            }
        }

        // ã‚¿ã‚°çµ±è¨ˆã‚’è¨ˆç®—
        function calculateTagStats() {
            tagStats = {};
            items.forEach(item => {
                (item.tagIds || item.tags || []).forEach(tagId => {
                    tagStats[tagId] = (tagStats[tagId] || 0) + 1;
                });
            });
        }

        // ã‚¿ã‚°åã‚’å–å¾—ï¼ˆã‚¿ã‚°å®šç¾©ãŒã‚ã‚‹å ´åˆã¯æ­£å¼åã€ãªã„å ´åˆã¯IDï¼‰
        function getTagDisplayName(tagId) {
            return tagDefinitions[tagId]?.name || tagId;
        }

        // ã‚¿ã‚°ã®è‰²ã‚’å–å¾—
        function getTagColor(tagId) {
            return tagDefinitions[tagId]?.color || '#6c757d';
        }

        // ç”»åƒä¸€è¦§ã‚’è¡¨ç¤º
        function renderImages() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = items.map(item => {
                const displayTags = (item.tagIds || item.tags || []).map(tagId => {
                    const name = getTagDisplayName(tagId);
                    const color = getTagColor(tagId);
                    const count = tagStats[tagId] || 0;
                    return `<span class="badge" style="background-color: ${color}" title="${count}å€‹ã®ç”»åƒã§ä½¿ç”¨">${name}</span>`;
                }).join(' ');
                
                return `
                <div class="col-md-4 col-lg-3">
                    <div class="card image-card h-100" onclick="openTagModal('${item.id}')">
                        <img src="${item.thumb}" class="card-img-top" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${item.title}</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${displayTags}
                            </div>
                            <small class="text-muted">${item.category}</small>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openTagModal(itemId) {
            currentItem = items.find(item => item.id === itemId);
            if (!currentItem) return;

            document.getElementById('modalImage').src = currentItem.thumb;
            document.getElementById('modalTitle').textContent = currentItem.title;
            
            renderCurrentTags();
            renderCommonTags();
            
            new bootstrap.Modal(document.getElementById('tagModal')).show();
        }

        // ç¾åœ¨ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
        function renderCurrentTags() {
            const container = document.getElementById('currentTags');
            const currentTags = currentItem.tagIds || currentItem.tags || [];
            
            container.innerHTML = currentTags.map(tagId => {
                const name = getTagDisplayName(tagId);
                const color = getTagColor(tagId);
                const count = tagStats[tagId] || 0;
                return `
                <span class="badge tag-badge" 
                      style="background-color: ${color}; cursor: pointer;" 
                      onclick="removeTag('${tagId}')"
                      title="${count}å€‹ã®ç”»åƒã§ä½¿ç”¨ä¸­">
                    ${name} Ã—
                </span>
                `;
            }).join('');
        }

        // ã‚ˆãä½¿ã†ã‚¿ã‚°ã‚’è¡¨ç¤º
        function renderCommonTags() {
            const container = document.getElementById('commonTags');
            
            // ä½¿ç”¨é »åº¦ã§ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸã‚¿ã‚°ãƒªã‚¹ãƒˆ
            const sortedTags = Object.entries(tagStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([tagId]) => tagId);
            
            // commonTagsListã¨çµ±åˆ
            const allCommonTags = Array.from(new Set([...sortedTags, ...commonTagsList]));
            
            container.innerHTML = allCommonTags.map(tagId => {
                const name = getTagDisplayName(tagId);
                const color = getTagColor(tagId);
                const count = tagStats[tagId] || 0;
                const currentTags = currentItem.tagIds || currentItem.tags || [];
                const isAlreadyAdded = currentTags.includes(tagId);
                
                return `
                <span class="badge tag-badge ${isAlreadyAdded ? 'bg-success' : ''}" 
                      onclick="${isAlreadyAdded ? '' : `addCommonTag('${tagId}')`}"
                      style="cursor: pointer; ${isAlreadyAdded ? '' : `border: 1px solid ${color}; color: ${color}; background: transparent;`}"
                      title="${count}å€‹ã®ç”»åƒã§ä½¿ç”¨ä¸­">
                    ${isAlreadyAdded ? 'âœ“ ' : '+ '}${name}
                </span>
                `;
            }).join('');
        }

        // ã‚¿ã‚°ã‚’è¿½åŠ 
        function addTag() {
            const input = document.getElementById('newTag');
            const tagId = input.value.trim();
            if (tagId && !getCurrentTagIds().includes(tagId)) {
                getCurrentTagIds().push(tagId);
                input.value = '';
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // ã‚ˆãä½¿ã†ã‚¿ã‚°ã‚’è¿½åŠ 
        function addCommonTag(tagId) {
            const currentTags = getCurrentTagIds();
            if (!currentTags.includes(tagId)) {
                currentTags.push(tagId);
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // ã‚¿ã‚°ã‚’å‰Šé™¤
        function removeTag(tagId) {
            const currentTags = getCurrentTagIds();
            const index = currentTags.indexOf(tagId);
            if (index > -1) {
                currentTags.splice(index, 1);
                renderCurrentTags();
                renderCommonTags();
            }
        }

        // ç¾åœ¨ã®ã‚¿ã‚°IDãƒªã‚¹ãƒˆã‚’å–å¾—
        function getCurrentTagIds() {
            if (!currentItem.tagIds) {
                currentItem.tagIds = currentItem.tags || [];
            }
            return currentItem.tagIds;
        }

        // ã‚¿ã‚°ã‚’ä¿å­˜ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIãŒå¿…è¦ï¼‰
        function saveTags() {
            // ã“ã“ã§å®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            console.log('Saving tags for', currentItem.id, ':', currentItem.tags);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¸€æ™‚ä¿å­˜ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            const savedTags = JSON.parse(localStorage.getItem('editedTags') || '{}');
            savedTags[currentItem.id] = currentItem.tags;
            localStorage.setItem('editedTags', JSON.stringify(savedTags));
            
            // ç”»é¢ã‚’æ›´æ–°
            renderImages();
            bootstrap.Modal.getInstance(document.getElementById('tagModal')).hide();
            
            alert('ã‚¿ã‚°ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
        }

        // Enterã‚­ãƒ¼ã§ã‚¿ã‚°è¿½åŠ 
        document.getElementById('newTag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTag();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        Promise.all([loadTagDefinitions(), loadImages()]);
    </script>
</body>
</html>
