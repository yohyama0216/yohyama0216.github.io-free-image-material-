<!-- index.html（差分のポイント：カードが detail へ飛ぶ・DLボタンは削除） -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>フリー画像素材集 | ゲーム開発向け高品質素材</title>
  <meta name="description" content="ゲーム開発に最適なフリー画像素材集。UI、背景、キャラクターなど豊富なカテゴリの高品質素材を無料で提供。商用利用可能で即ダウンロード可能です。">
  <meta name="keywords" content="フリー素材,ゲーム素材,画像素材,UI素材,背景素材,無料ダウンロード,商用利用可能">
  <meta name="author" content="Free Game Materials">
  <meta property="og:title" content="フリー画像素材集 | ゲーム開発向け高品質素材">
  <meta property="og:description" content="ゲーム開発に最適なフリー画像素材集。UI、背景、キャラクターなど豊富なカテゴリの高品質素材を無料で提供。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yohyama0216.github.io/free-image-material/">
  <meta property="og:image" content="https://yohyama0216.github.io/free-image-material/assets/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="フリー画像素材集 | ゲーム開発向け高品質素材">
  <meta name="twitter:description" content="ゲーム開発に最適なフリー画像素材集。UI、背景、キャラクターなど豊富なカテゴリの高品質素材を無料で提供。">
  <meta name="twitter:image" content="https://yohyama0216.github.io/free-image-material/assets/og-image.jpg">
  <link rel="canonical" href="https://yohyama0216.github.io/free-image-material/">
  <link rel="icon" href="data:," />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
<header class="border-bottom">
  <div class="container">
    <h1 class="h2 my-3">Free Game Materials</h1>
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <input id="q" type="search" class="form-control" placeholder="キーワード検索（例：sky, ui, grass）">
      </div>
      <div class="col-md-3">
        <select id="cat" class="form-select">
          <option value="">すべてのカテゴリ</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="sort" class="form-select">
          <option value="title">並び替え：タイトル</option>
          <option value="wdesc">並び替え：横幅（大→小）</option>
          <option value="wasc">並び替え：横幅（小→大）</option>
        </select>
      </div>
      <div class="col-md-2">
        <button id="clearTags" class="btn btn-outline-danger w-100" title="選択中のタグをクリア">
          <span>🏷️</span> クリア
        </button>
      </div>
    </div>
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">タグで絞り込み：</h6>
        <small id="tagStats" class="text-muted"></small>
      </div>
      <div id="tagbar" class="d-flex flex-wrap gap-2"></div>
      <div id="selectedTags" class="mt-2" style="display: none;">
        <small class="text-muted">選択中：</small>
        <div id="selectedTagsList" class="d-inline-flex flex-wrap gap-1 ms-2"></div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <div id="grid" class="row g-3"></div>
  </div>
</main>

<footer class="border-top mt-4">
  <div class="container py-3">
    <small class="text-muted">© 2025 Free Game Materials</small>
  </div>
</footer>

<script>
(async function(){
  const res = await fetch("assets.json");
  const data = await res.json();
  let items = data.items || [];

  const cats = Array.from(new Set(items.map(x => x.category))).sort();
  const tags = Array.from(new Set(items.flatMap(x => x.tags))).sort();

  // タグの使用頻度を計算
  const tagFreq = {};
  items.forEach(item => {
    item.tags.forEach(tag => {
      tagFreq[tag] = (tagFreq[tag] || 0) + 1;
    });
  });

  const catSel = document.getElementById("cat");
  cats.forEach(c => { const o=document.createElement("option"); o.value=c; o.textContent=c; catSel.appendChild(o); });

  const tagbar = document.getElementById("tagbar");
  const activeTags = new Set();
  
  // タグを頻度順でソート
  const sortedTags = tags.sort((a, b) => tagFreq[b] - tagFreq[a]);
  
  sortedTags.forEach(t => {
    const b=document.createElement("button");
    const freq = tagFreq[t];
    const maxFreq = Math.max(...Object.values(tagFreq));
    const freqLevel = Math.min(5, Math.ceil((freq / maxFreq) * 5));
    
    // Bootstrapのサイズクラスを使用
    let sizeClass = "btn-sm";
    if (freqLevel >= 4) sizeClass = "";  // 通常サイズ
    else if (freqLevel >= 3) sizeClass = "btn-sm";
    else sizeClass = "btn-sm";
    
    b.type="button"; 
    b.className=`btn btn-outline-secondary ${sizeClass} me-1 mb-1`; 
    b.textContent=`${t} (${freq})`;
    b.title=`${freq}個のアイテムにこのタグが使用されています`;
    b.setAttribute("data-tag", t);
    b.onclick=()=>{ 
      b.classList.toggle("active");
      if (b.classList.contains("active")) {
        b.classList.remove("btn-outline-secondary");
        b.classList.add("btn-secondary");
      } else {
        b.classList.remove("btn-secondary");
        b.classList.add("btn-outline-secondary");
      }
      activeTags.has(t) ? activeTags.delete(t) : activeTags.add(t); 
      updateSelectedTags();
      render(); 
    };
    tagbar.appendChild(b);
  });

  const q = document.getElementById("q");
  const sortSel = document.getElementById("sort");
  const clearTagsBtn = document.getElementById("clearTags");
  
  q.addEventListener("input", render);
  catSel.addEventListener("change", render);
  sortSel.addEventListener("change", render);
  
  // タグクリア機能
  clearTagsBtn.addEventListener("click", () => {
    activeTags.clear();
    document.querySelectorAll("[data-tag]").forEach(tag => {
      tag.classList.remove("active", "btn-secondary");
      tag.classList.add("btn-outline-secondary");
    });
    updateSelectedTags();
    render();
  });

  function sortItems(arr){
    const v = sortSel.value;
    if (v === "wdesc") return arr.sort((a,b) => (b.width||0)-(a.width||0));
    if (v === "wasc") return arr.sort((a,b) => (a.width||0)-(b.width||0));
    return arr.sort((a,b) => a.title.localeCompare(b.title));
  }

  // 選択されたタグの表示を更新
  function updateSelectedTags() {
    const selectedDiv = document.getElementById("selectedTags");
    const listDiv = document.getElementById("selectedTagsList");
    const statsDiv = document.getElementById("tagStats");
    
    if (activeTags.size === 0) {
      selectedDiv.style.display = "none";
    } else {
      selectedDiv.style.display = "block";
      listDiv.innerHTML = "";
      
      [...activeTags].forEach(tag => {
        const badge = document.createElement("span");
        badge.className = "badge bg-primary";
        badge.innerHTML = `${tag} <button type="button" class="btn-close btn-close-white" style="font-size:0.7em;" aria-label="Remove ${tag}"></button>`;
        badge.querySelector(".btn-close").onclick = (e) => {
          e.preventDefault();
          activeTags.delete(tag);
          const tagBtn = document.querySelector(`[data-tag="${tag}"]`);
          if (tagBtn) {
            tagBtn.classList.remove("active", "btn-secondary");
            tagBtn.classList.add("btn-outline-secondary");
          }
          updateSelectedTags();
          render();
        };
        listDiv.appendChild(badge);
      });
    }
    
    // タグ統計情報
    const totalTags = tags.length;
    const usedTags = activeTags.size;
    statsDiv.textContent = usedTags > 0 ? 
      `${usedTags}/${totalTags}個のタグで絞り込み中` : 
      `全${totalTags}個のタグ`;
  }

  function match(x){
    const kw = q.value.trim().toLowerCase();
    const kwok = !kw || [x.title, x.category, ...(x.tags||[])].join(" ").toLowerCase().includes(kw);
    const catok = !catSel.value || x.category === catSel.value;
    const tagok = activeTags.size===0 || [...activeTags].every(t => x.tags.includes(t));
    return kwok && catok && tagok;
  }

  function card(t){
    const div = document.createElement("div");
    div.className = "col-md-4 col-lg-3";
    const a = document.createElement("a");
    a.className = "card h-100 text-decoration-none text-body";
    a.href = `items/${t.slug}/`;     // ← 詳細ページへ
    a.innerHTML = `
      <img class="card-img-top object-fit-cover" loading="lazy" src="${t.thumb}" alt="${t.title} - ${t.category}素材画像" style="height: 200px;">
      <div class="card-body">
        <h5 class="card-title">${t.title}</h5>
        <p class="card-text">
          <small class="text-muted">${t.category} · ${t.tags.join(", ")}</small><br>
          <small class="text-muted">${t.width || "?"}×${t.height || "?"} · ${t.license}</small>
        </p>
      </div>`;
    div.appendChild(a);
    return div;
  }

  function render(){
    const matched = items.filter(match);
    const sorted = sortItems([...matched]);
    
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    sorted.forEach(x => grid.appendChild(card(x)));
    
    // 検索結果の統計表示
    const resultCount = matched.length;
    const totalCount = items.length;
    document.title = resultCount < totalCount ? 
      `${resultCount}件の結果 - フリー画像素材集` : 
      "フリー画像素材集 | ゲーム開発向け高品質素材";
      
    // ページ上部に結果数表示
    let resultInfo = document.getElementById("resultInfo");
    if (!resultInfo) {
      resultInfo = document.createElement("div");
      resultInfo.id = "resultInfo";
      resultInfo.className = "alert alert-info mb-3";
      grid.parentNode.insertBefore(resultInfo, grid);
    }
    
    if (resultCount < totalCount) {
      const filters = [];
      if (q.value.trim()) filters.push(`キーワード「${q.value.trim()}」`);
      if (catSel.value) filters.push(`カテゴリ「${catSel.value}」`);
      if (activeTags.size > 0) filters.push(`タグ「${[...activeTags].join(", ")}」`);
      
      resultInfo.innerHTML = `
        <strong>${resultCount}件</strong> の結果が見つかりました（全${totalCount}件中）
        ${filters.length > 0 ? `<br><small>絞り込み条件: ${filters.join(" + ")}</small>` : ""}
      `;
      resultInfo.style.display = "block";
    } else {
      resultInfo.style.display = "none";
    }
    
    updateSelectedTags();
  }
  render();
  updateSelectedTags(); // 初期状態のタグ統計を表示
})();
</script>
</body>
</html>
