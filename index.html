<!-- index.html - ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨ -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ•ãƒªãƒ¼ç”»åƒç´ æé›† | ã‚²ãƒ¼ãƒ é–‹ç™ºå‘ã‘é«˜å“è³ªç´ æ</title>
  <meta name="description" content="ã‚²ãƒ¼ãƒ é–‹ç™ºã«æœ€é©ãªãƒ•ãƒªãƒ¼ç”»åƒç´ æé›†ã€‚UIã€èƒŒæ™¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã©è±Šå¯Œãªã‚«ãƒ†ã‚´ãƒªã®é«˜å“è³ªç´ æã‚’ç„¡æ–™ã§æä¾›ã€‚å•†ç”¨åˆ©ç”¨å¯èƒ½ã§å³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚">
  <meta name="keywords" content="ãƒ•ãƒªãƒ¼ç´ æ,ã‚²ãƒ¼ãƒ ç´ æ,ç”»åƒç´ æ,UIç´ æ,èƒŒæ™¯ç´ æ,ç„¡æ–™ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰,å•†ç”¨åˆ©ç”¨å¯èƒ½">
  <meta name="author" content="Free Game Materials">
  <meta property="og:title" content="ãƒ•ãƒªãƒ¼ç”»åƒç´ æé›† | ã‚²ãƒ¼ãƒ é–‹ç™ºå‘ã‘é«˜å“è³ªç´ æ">
  <meta property="og:description" content="ã‚²ãƒ¼ãƒ é–‹ç™ºã«æœ€é©ãªãƒ•ãƒªãƒ¼ç”»åƒç´ æé›†ã€‚UIã€èƒŒæ™¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã©è±Šå¯Œãªã‚«ãƒ†ã‚´ãƒªã®é«˜å“è³ªç´ æã‚’ç„¡æ–™ã§æä¾›ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yohyama0216.github.io/free-image-material/">
  <meta property="og:image" content="https://yohyama0216.github.io/free-image-material/assets/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ãƒ•ãƒªãƒ¼ç”»åƒç´ æé›† | ã‚²ãƒ¼ãƒ é–‹ç™ºå‘ã‘é«˜å“è³ªç´ æ">
  <meta name="twitter:description" content="ã‚²ãƒ¼ãƒ é–‹ç™ºã«æœ€é©ãªãƒ•ãƒªãƒ¼ç”»åƒç´ æé›†ã€‚UIã€èƒŒæ™¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã©è±Šå¯Œãªã‚«ãƒ†ã‚´ãƒªã®é«˜å“è³ªç´ æã‚’ç„¡æ–™ã§æä¾›ã€‚">
  <meta name="twitter:image" content="https://yohyama0216.github.io/free-image-material/assets/og-image.jpg">
  <link rel="canonical" href="https://yohyama0216.github.io/free-image-material/">
  <link rel="icon" href="data:," />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
<!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<section class="bg-primary text-white py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <h1 class="display-4 fw-bold mb-3">Free Game Materials</h1>
        <p class="lead mb-4">ã‚²ãƒ¼ãƒ é–‹ç™ºã«æœ€é©ãªãƒ•ãƒªãƒ¼ç”»åƒç´ æé›†ã€‚UIã€èƒŒæ™¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãªã©è±Šå¯Œãªã‚«ãƒ†ã‚´ãƒªã®é«˜å“è³ªç´ æã‚’ç„¡æ–™ã§æä¾›ã€‚å•†ç”¨åˆ©ç”¨å¯èƒ½ã§å³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚</p>
        <div class="d-flex gap-3">
          <span class="badge bg-light text-dark px-3 py-2">å•†ç”¨åˆ©ç”¨OK</span>
          <span class="badge bg-light text-dark px-3 py-2">é«˜å“è³ª</span>
          <span class="badge bg-light text-dark px-3 py-2">å³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
        </div>
      </div>
      <div class="col-lg-6 text-center">
        <div class="bg-white bg-opacity-10 rounded p-4">
          <h3 class="h5 mb-3">ğŸ® ç´ æã‚’æ¢ã™</h3>
          <div class="input-group mb-3">
            <input id="heroSearch" type="search" class="form-control" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
            <button class="btn btn-light" type="button" onclick="performHeroSearch()">
              <i class="bi bi-search"></i> æ¤œç´¢
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- çµ±è¨ˆæƒ…å ± -->
<section class="py-4 bg-light">
  <div class="container">
    <div class="row text-center">
      <div class="col-md-3">
        <div class="h4 fw-bold text-primary" id="totalItems">-</div>
        <div class="text-muted">ç·ç´ ææ•°</div>
      </div>
      <div class="col-md-3">
        <div class="h4 fw-bold text-primary" id="totalCategories">-</div>
        <div class="text-muted">ã‚«ãƒ†ã‚´ãƒª</div>
      </div>
      <div class="col-md-3">
        <div class="h4 fw-bold text-primary" id="totalTags">-</div>
        <div class="text-muted">ã‚¿ã‚°</div>
      </div>
      <div class="col-md-3">
        <div class="h4 fw-bold text-primary">CC0</div>
        <div class="text-muted">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</div>
      </div>
    </div>
  </div>
</section>

<!-- æ–°ç€ç´ æ -->
<section class="py-5">
  <div class="container">
    <div class="text-center mb-4">
      <h2 class="h3 fw-bold">ğŸ†• æ–°ç€ç´ æ</h2>
      <p class="text-muted">æœ€è¿‘è¿½åŠ ã•ã‚ŒãŸç´ æã‚’ãƒã‚§ãƒƒã‚¯ï¼</p>
    </div>
    
    <div id="latestItems" class="row g-4 mb-4">
      <!-- æ–°ç€ç´ æãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
    </div>
    
    <div class="text-center">
      <button onclick="scrollToSearch()" class="btn btn-outline-primary btn-lg">
        ã™ã¹ã¦ã®ç´ æã‚’è¦‹ã‚‹ â†’
      </button>
    </div>
  </div>
</section>

<!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<section class="py-4 border-bottom">
  <div class="container">
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <label class="form-label fw-semibold">ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
        <input id="q" type="search" class="form-control" placeholder="ä¾‹ï¼šsky, ui, grass">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">ğŸ“ ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="cat" class="form-select">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">ğŸ“Š ä¸¦ã³æ›¿ãˆ</label>
        <select id="sort" class="form-select">
          <option value="title">ã‚¿ã‚¤ãƒˆãƒ«é †</option>
          <option value="wdesc">ã‚µã‚¤ã‚ºå¤§â†’å°</option>
          <option value="wasc">ã‚µã‚¤ã‚ºå°â†’å¤§</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold">ğŸ·ï¸ ã‚¿ã‚°</label>
        <button id="clearTags" class="btn btn-outline-danger w-100" title="é¸æŠä¸­ã®ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢">
          ã‚¯ãƒªã‚¢
        </button>
      </div>
    </div>
    <!-- ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰ -->
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-semibold">ğŸ·ï¸ ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</h6>
          <div class="d-flex gap-2 align-items-center">
            <small id="tagStats" class="text-muted"></small>
            <a href="tags.html" class="btn btn-outline-secondary btn-sm">
              ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div id="tagbar" class="d-flex flex-wrap gap-2"></div>
        <div id="selectedTags" class="mt-3 p-2 bg-light rounded" style="display: none;">
          <small class="text-muted fw-semibold">é¸æŠä¸­ã®ã‚¿ã‚°ï¼š</small>
          <div id="selectedTagsList" class="d-inline-flex flex-wrap gap-1 ms-2"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<main class="py-4">
  <div class="container">
    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="resultInfo" class="alert alert-info mb-4" style="display: none;"></div>
    
    <!-- ç´ æã‚°ãƒªãƒƒãƒ‰ -->
    <div id="grid" class="row g-3"></div>
  </div>
</main>

<footer class="bg-dark text-white py-4 mt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h5>Free Game Materials</h5>
        <p class="text-muted">ã‚²ãƒ¼ãƒ é–‹ç™ºã«æœ€é©ãªãƒ•ãƒªãƒ¼ç´ æã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚</p>
      </div>
      <div class="col-md-2">
        <h6>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h6>
        <ul class="list-unstyled">
          <li><a href="./" class="text-light text-decoration-none">ç´ æä¸€è¦§</a></li>
          <li><a href="tags.html" class="text-light text-decoration-none">ã‚¿ã‚°ä¸€è¦§</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <h6>ã‚«ãƒ†ã‚´ãƒª</h6>
        <div id="footerCategories" class="d-flex flex-wrap gap-1">
          <!-- ã‚«ãƒ†ã‚´ãƒªãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
      </div>
      <div class="col-md-3">
        <h6>åˆ©ç”¨ã«ã¤ã„ã¦</h6>
        <ul class="list-unstyled">
          <li><small>âœ“ å•†ç”¨åˆ©ç”¨å¯èƒ½</small></li>
          <li><small>âœ“ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆä¸è¦</small></li>
          <li><small>âœ“ åŠ å·¥ãƒ»æ”¹å¤‰OK</small></li>
        </ul>
      </div>
    </div>
    <hr class="my-3">
    
    <!-- ã‚¿ã‚°ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="row mb-4">
      <div class="col-12">
        <h6 class="text-white mb-3">ğŸ·ï¸ ã™ã¹ã¦ã®ã‚¿ã‚°</h6>
        <div id="footerTags" class="d-flex flex-wrap gap-2">
          <!-- ã‚¿ã‚°ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
      </div>
    </div>
    
    <div class="text-center">
      <small class="text-muted">Â© 2025 Free Game Materials. All rights reserved.</small>
    </div>
  </div>
</footer>

<script>
// ãƒ’ãƒ¼ãƒ­ãƒ¼æ¤œç´¢æ©Ÿèƒ½
function performHeroSearch() {
  const heroInput = document.getElementById("heroSearch");
  const mainInput = document.getElementById("q");
  mainInput.value = heroInput.value;
  
  // æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
  
  // æ¤œç´¢ã‚’å®Ÿè¡Œ
  render();
}

// æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
function scrollToSearch() {
  document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
}

// æ–°ç€ç´ æã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
function createLatestCard(item) {
  const div = document.createElement("div");
  div.className = "col-lg-2 col-md-4 col-6";
  
  const a = document.createElement("a");
  a.className = "card h-100 text-decoration-none text-body border-0 shadow-sm";
  a.href = `items/${item.slug}/`;
  a.innerHTML = `
    <div class="position-relative">
      <img class="card-img-top object-fit-cover" loading="lazy" src="${item.thumb}" alt="${item.title}" style="height: 160px;">
      <div class="position-absolute top-0 start-0 m-2">
        <span class="badge bg-success">NEW</span>
      </div>
      <div class="position-absolute top-0 end-0 m-2">
        <span class="badge bg-primary">${item.category}</span>
      </div>
    </div>
    <div class="card-body p-3">
      <h6 class="card-title mb-1 small">${item.title}</h6>
      <div class="d-flex flex-wrap gap-1 mb-2">
        ${item.tags.slice(0, 2).map(tag => `<span class="badge bg-light text-dark small">${tag}</span>`).join('')}
        ${item.tags.length > 2 ? `<span class="badge bg-light text-muted small">+${item.tags.length - 2}</span>` : ''}
      </div>
      <small class="text-muted">${item.width || "?"}Ã—${item.height || "?"}</small>
    </div>
  `;
  
  // ãƒ›ãƒãƒ¼åŠ¹æœ
  a.onmouseenter = () => {
    a.classList.add("shadow");
    a.style.transform = "translateY(-2px)";
  };
  a.onmouseleave = () => {
    a.classList.remove("shadow");
    a.style.transform = "translateY(0)";
  };
  
  div.appendChild(a);
  return div;
}

// æ–°ç€ç´ æã‚’è¡¨ç¤º
function renderLatestItems(items) {
  const container = document.getElementById("latestItems");
  
  // æœ€æ–°ã®5ã¤ã®ç´ æã‚’å–å¾—ï¼ˆä»®æƒ³çš„ã«æœ€æ–°é †ã¨ã™ã‚‹ï¼‰
  const latestItems = items.slice(-5).reverse();
  
  container.innerHTML = "";
  latestItems.forEach(item => {
    container.appendChild(createLatestCard(item));
  });
}
(async function(){
  const res = await fetch("assets.json");
  const data = await res.json();
  let items = data.items || [];

  const cats = Array.from(new Set(items.map(x => x.category))).sort();
  const tags = Array.from(new Set(items.flatMap(x => x.tags))).sort();

  // ã‚¿ã‚°ã®ä½¿ç”¨é »åº¦ã‚’è¨ˆç®—
  const tagFreq = {};
  items.forEach(item => {
    item.tags.forEach(tag => {
      tagFreq[tag] = (tagFreq[tag] || 0) + 1;
    });
  });

  // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
  document.getElementById("totalItems").textContent = items.length;
  document.getElementById("totalCategories").textContent = cats.length;
  document.getElementById("totalTags").textContent = tags.length;

  // æ–°ç€ç´ æã‚’è¡¨ç¤º
  renderLatestItems(items);

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ã‚°ã‚„ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿å–ã‚Š
  const urlParams = new URLSearchParams(window.location.search);
  const tagParam = urlParams.get('tag');
  const categoryParam = urlParams.get('category');
  
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦åˆæœŸè¨­å®š
  if (categoryParam) {
    document.getElementById("cat").value = categoryParam;
  }

  // ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
  const footerCats = document.getElementById("footerCategories");
  cats.slice(0, 8).forEach(cat => {
    const badge = document.createElement("span");
    badge.className = "badge bg-secondary text-decoration-none";
    badge.textContent = cat;
    badge.style.cursor = "pointer";
    badge.onclick = () => {
      document.getElementById("cat").value = cat;
      document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
      render();
    };
    footerCats.appendChild(badge);
  });

  // ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚¿ã‚°ä¸€è¦§ã‚’è¿½åŠ 
  const footerTags = document.getElementById("footerTags");
  
  // ã‚¿ã‚°ã‚’é »åº¦é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½30å€‹ã‚’è¡¨ç¤º
  const sortedFooterTags = tags.sort((a, b) => {
    const freqA = tagFreq[a] || 0;
    const freqB = tagFreq[b] || 0;
    return freqB - freqA;
  }).slice(0, 30);
  
  sortedFooterTags.forEach(tag => {
    const tagLink = document.createElement("span");
    tagLink.className = "badge bg-outline-light text-light border border-secondary";
    tagLink.style.cursor = "pointer";
    tagLink.textContent = tag;
    tagLink.title = `ã€Œ${tag}ã€ã§çµã‚Šè¾¼ã¿æ¤œç´¢`;
    
    tagLink.onclick = () => {
      // ãƒ¡ã‚¤ãƒ³ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      const mainTagBtn = document.querySelector(`[data-tag="${tag}"]`);
      if (mainTagBtn && !mainTagBtn.classList.contains("active")) {
        mainTagBtn.click(); // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      }
      
      // æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
    };
    
    tagLink.onmouseenter = () => {
      tagLink.classList.remove("bg-outline-light");
      tagLink.classList.add("bg-light", "text-dark");
    };
    
    tagLink.onmouseleave = () => {
      tagLink.classList.remove("bg-light", "text-dark");
      tagLink.classList.add("bg-outline-light");
    };
    
    footerTags.appendChild(tagLink);
  });

  const catSel = document.getElementById("cat");
  cats.forEach(c => { const o=document.createElement("option"); o.value=c; o.textContent=c; catSel.appendChild(o); });

  const tagbar = document.getElementById("tagbar");
  const activeTags = new Set();
  
  // ã‚¿ã‚°ã‚’é »åº¦é †ã§ã‚½ãƒ¼ãƒˆ
  const sortedTags = tags.sort((a, b) => tagFreq[b] - tagFreq[a]);
  
  sortedTags.forEach(t => {
    const b=document.createElement("button");
    const freq = tagFreq[t];
    const maxFreq = Math.max(...Object.values(tagFreq));
    const freqLevel = Math.min(5, Math.ceil((freq / maxFreq) * 5));
    
    // Bootstrapã®ã‚µã‚¤ã‚ºã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
    let sizeClass = "btn-sm";
    if (freqLevel >= 4) sizeClass = "";  // é€šå¸¸ã‚µã‚¤ã‚º
    else if (freqLevel >= 3) sizeClass = "btn-sm";
    else sizeClass = "btn-sm";
    
    b.type="button"; 
    b.className=`btn btn-outline-secondary ${sizeClass} me-1 mb-1`; 
    b.textContent=`${t} (${freq})`;
    b.title=`${freq}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ã“ã®ã‚¿ã‚°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™`;
    b.setAttribute("data-tag", t);
    b.onclick=()=>{ 
      b.classList.toggle("active");
      if (b.classList.contains("active")) {
        b.classList.remove("btn-outline-secondary");
        b.classList.add("btn-secondary");
      } else {
        b.classList.remove("btn-secondary");
        b.classList.add("btn-outline-secondary");
      }
      activeTags.has(t) ? activeTags.delete(t) : activeTags.add(t); 
      updateSelectedTags();
      render(); 
    };
    tagbar.appendChild(b);
  });

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¿ã‚°ã‚’è‡ªå‹•é¸æŠ
  if (tagParam) {
    const tagBtn = document.querySelector(`[data-tag="${tagParam}"]`);
    if (tagBtn) {
      tagBtn.click(); // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      // ãƒ¡ã‚¤ãƒ³ã®æ¤œç´¢ã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      setTimeout(() => {
        document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }
  }

  const q = document.getElementById("q");
  const sortSel = document.getElementById("sort");
  const clearTagsBtn = document.getElementById("clearTags");
  
  q.addEventListener("input", render);
  catSel.addEventListener("change", render);
  sortSel.addEventListener("change", render);
  
  // ã‚¿ã‚°ã‚¯ãƒªã‚¢æ©Ÿèƒ½
  clearTagsBtn.addEventListener("click", () => {
    activeTags.clear();
    document.querySelectorAll("[data-tag]").forEach(tag => {
      tag.classList.remove("active", "btn-secondary");
      tag.classList.add("btn-outline-secondary");
    });
    updateSelectedTags();
    render();
  });

  function sortItems(arr){
    const v = sortSel.value;
    if (v === "wdesc") return arr.sort((a,b) => (b.width||0)-(a.width||0));
    if (v === "wasc") return arr.sort((a,b) => (a.width||0)-(b.width||0));
    return arr.sort((a,b) => a.title.localeCompare(b.title));
  }

  // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã®è¡¨ç¤ºã‚’æ›´æ–°
  function updateSelectedTags() {
    const selectedDiv = document.getElementById("selectedTags");
    const listDiv = document.getElementById("selectedTagsList");
    const statsDiv = document.getElementById("tagStats");
    
    if (activeTags.size === 0) {
      selectedDiv.style.display = "none";
    } else {
      selectedDiv.style.display = "block";
      listDiv.innerHTML = "";
      
      [...activeTags].forEach(tag => {
        const badge = document.createElement("span");
        badge.className = "badge bg-primary";
        badge.innerHTML = `${tag} <button type="button" class="btn-close btn-close-white" style="font-size:0.7em;" aria-label="Remove ${tag}"></button>`;
        badge.querySelector(".btn-close").onclick = (e) => {
          e.preventDefault();
          activeTags.delete(tag);
          const tagBtn = document.querySelector(`[data-tag="${tag}"]`);
          if (tagBtn) {
            tagBtn.classList.remove("active", "btn-secondary");
            tagBtn.classList.add("btn-outline-secondary");
          }
          updateSelectedTags();
          render();
        };
        listDiv.appendChild(badge);
      });
    }
    
    // ã‚¿ã‚°çµ±è¨ˆæƒ…å ±
    const totalTags = tags.length;
    const usedTags = activeTags.size;
    statsDiv.textContent = usedTags > 0 ? 
      `${usedTags}/${totalTags}å€‹ã®ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿ä¸­` : 
      `å…¨${totalTags}å€‹ã®ã‚¿ã‚°`;
  }

  function match(x){
    const kw = q.value.trim().toLowerCase();
    const kwok = !kw || [x.title, x.category, ...(x.tags||[])].join(" ").toLowerCase().includes(kw);
    const catok = !catSel.value || x.category === catSel.value;
    const tagok = activeTags.size===0 || [...activeTags].every(t => x.tags.includes(t));
    return kwok && catok && tagok;
  }

  function card(t){
    const div = document.createElement("div");
    div.className = "col-xl-3 col-lg-4 col-md-6";
    const a = document.createElement("a");
    a.className = "card h-100 text-decoration-none text-body shadow-sm";
    a.href = `items/${t.slug}/`;
    a.innerHTML = `
      <div class="position-relative">
        <img class="card-img-top object-fit-cover" loading="lazy" src="${t.thumb}" alt="${t.title}" style="height: 220px;">
        <div class="position-absolute top-0 end-0 m-2">
          <span class="badge bg-primary">${t.category}</span>
        </div>
        <div class="position-absolute bottom-0 start-0 end-0 bg-gradient" style="background: linear-gradient(transparent, rgba(0,0,0,0.7)); height: 60px;"></div>
        <div class="position-absolute bottom-0 start-0 p-2">
          <small class="text-white fw-semibold">${t.width || "?"}Ã—${t.height || "?"}</small>
        </div>
      </div>
      <div class="card-body">
        <h6 class="card-title mb-2">${t.title}</h6>
        <div class="d-flex flex-wrap gap-1 mb-2">
          ${t.tags.slice(0, 3).map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join('')}
          ${t.tags.length > 3 ? `<span class="badge bg-light text-muted">+${t.tags.length - 3}</span>` : ''}
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">${t.license}</small>
          <small class="text-primary fw-semibold">è©³ç´° â†’</small>
        </div>
      </div>`;
    
    // ãƒ›ãƒãƒ¼åŠ¹æœ
    a.onmouseenter = () => a.classList.add("shadow");
    a.onmouseleave = () => a.classList.remove("shadow");
    
    div.appendChild(a);
    return div;
  }

  function render(){
    const matched = items.filter(match);
    const sorted = sortItems([...matched]);
    
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    sorted.forEach(x => grid.appendChild(card(x)));
    
    // æ¤œç´¢çµæœã®çµ±è¨ˆè¡¨ç¤º
    const resultCount = matched.length;
    const totalCount = items.length;
    document.title = resultCount < totalCount ? 
      `${resultCount}ä»¶ã®çµæœ - ãƒ•ãƒªãƒ¼ç”»åƒç´ æé›†` : 
      "ãƒ•ãƒªãƒ¼ç”»åƒç´ æé›† | ã‚²ãƒ¼ãƒ é–‹ç™ºå‘ã‘é«˜å“è³ªç´ æ";
      
    // çµæœæƒ…å ±ã®è¡¨ç¤º
    const resultInfo = document.getElementById("resultInfo");
    
    if (resultCount < totalCount) {
      const filters = [];
      if (q.value.trim()) filters.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${q.value.trim()}ã€`);
      if (catSel.value) filters.push(`ã‚«ãƒ†ã‚´ãƒªã€Œ${catSel.value}ã€`);
      if (activeTags.size > 0) filters.push(`ã‚¿ã‚°ã€Œ${[...activeTags].join(", ")}ã€`);
      
      resultInfo.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi bi-funnel me-2"></i>
          <strong>${resultCount}ä»¶</strong> ã®çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆå…¨${totalCount}ä»¶ä¸­ï¼‰
          ${filters.length > 0 ? `<br><small class="ms-4">çµã‚Šè¾¼ã¿æ¡ä»¶: ${filters.join(" + ")}</small>` : ""}
        </div>
      `;
      resultInfo.style.display = "block";
    } else {
      resultInfo.style.display = "none";
    }
    
    updateSelectedTags();
  }
  render();
  updateSelectedTags(); // åˆæœŸçŠ¶æ…‹ã®ã‚¿ã‚°çµ±è¨ˆã‚’è¡¨ç¤º
})();
</script>
</body>
</html>
